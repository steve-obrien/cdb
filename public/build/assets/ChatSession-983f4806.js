import{l as x,Z as y,j as T,x as u,O as S,p as l,o as a,f as r,a as h,w as _,F as d,b as o,q as p,t as g,d as $}from"./app-5a04eb8f.js";import b from"./PromptForm-8bac1295.js";import I from"./ChatMessage-9faa2b64.js";import{_ as L}from"./AuthenticatedLayout-e0ef55ae.js";import P from"./ChatList-c1060d01.js";import{_ as H}from"./_plugin-vue_export-helper-c27b6911.js";const M=x({props:{user:Object,chats:Array,sessions:Array,sessionId:{required:!0,type:String}},components:{Head:y,Link:T,AuthenticatedLayout:L,PromptForm:b,ChatMessage:I,ChatList:P},data(){return{prompt:"",data:[],messages:[],charsPerToken:4,tokenCostPerThousand:.005,isUserScrollBottom:!0,channel:null,channelTeam:null,users:{}}},unmounted(){window.Echo.leave(`chat.${this.sessionId}`)},mounted(){window.chat=this,this.messages=this.chats,u(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)});const t=window.Echo.join(`chat.${this.sessionId}`).here(s=>{console.log(s,"chat session channel"),s.forEach(e=>{this.users[e.id]=e})}).joining(s=>{console.log("joining",s.name),this.users[s.id]=s}).leaving(s=>{this.$page.props.auth.user.id!==s.id&&delete this.users[s.id]}).error(s=>{console.error(s)});t.listen("ChatMessage",s=>{console.log("ChatMessage - new from push",s),this.addChatChunk(s.message,"")}),t.listen("ChatMessageChunk",s=>{this.addChatChunk(s.message,s.contentChunk),console.log("ChatMessageChunk",s)})},computed:{messageCosts(){let t="";return this.messages.map(s=>{t+=s.content;let e=t.length;s.role=="assistant"&&(e=s.content.length);const i=e/this.charsPerToken,c=i/1e3*this.tokenCostPerThousand,f=s.content.length/this.charsPerToken,m=s.content.length;return{role:s.role,length:e,messageLength:m,tokens:i,cost:c,mesageTokens:f}})},total(){const s=this.messageCosts.reduce((i,c)=>i+c.length,0)/this.charsPerToken,e=s/1e3*this.tokenCostPerThousand;return{tokens:s,cost:e.toFixed(4)}},totalTokens(){return this.messages.reduce((t,s)=>typeof s.total_tokens=="number"?t+s.total_tokens:t,0)},totalCost(){return(this.totalTokens/1e3*this.tokenCostPerThousand).toFixed(4)}},methods:{go(t){S.visit(t)},addChatChunk(t,s){this.addMessage(t,s),u(()=>{this.scrollToBottom()})},addMessage(t,s){const e=this.messages.findIndex(i=>i.id===t.id);e===-1?this.messages.push(t):this.messages[e].content=(this.messages[e].content??"")+(s.delta.content??"")},handleScroll(){console.log("USER SCROLL");let t=this.$refs.chatWindow;this.isUserScrollBottom=t.scrollTop+t.clientHeight>=t.scrollHeight-100},scrollToBottom(){this.isUserScrollBottom&&this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)},send:async function(t){const s=t.prompt,e=await axios.post(route("api.chatStart"),{sessionId:this.sessionId,prompt:s});e.status!=200&&alert("error!"),console.log(e.data,"response.data"),e.data.sessionId!==this.sessionId&&alert("session ids do not match!?"),e.data.chat,u(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)}),this.prompt="",this.streamResponse(this.sessionId)},streamResponse(t){try{const s=new EventSource(route("api.chatStream",t),{withCredentials:!0});s.addEventListener("stop",e=>{s.close()}),s.addEventListener("error",e=>{console.error("EventSource failed:",e)})}catch(s){console.error("There was a problem with the streaming operation:",s)}}}});const B=o("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Chat",-1),E=["value"],W={class:"ml-auto flex items-center"},j=["href"],F=o("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15"})],-1),A={class:"flex h-full"},U={class:"@container h-full grow flex flex-col bg-white dark:bg-black"},O={class:"grow flex relative"},R={class:"px-4 py-8 flex flex-col flex-1 text-base mx-auto gap-5 @md:max-w-3xl @lg:max-w-[40rem] @xl:max-w-[48rem] group final-completion"},V={key:0},N=o("div",{class:"flex"},[o("div",{class:"h-8 w-8 min-w-8 mr-2 rounded-full flex items-center justify-center bg-black text-white"},"AI"),o("div",null,[o("div",{class:"mt-1 font-semibold"},"ChatGPT"),o("div",{class:"prose"},"How can I help you today?")])],-1),q=[N],z={class:"px-4"},D={class:"text-center"},G={class:"text-xs"},Z={class:"flex"},J=["src","alt"];function K(t,s,e,i,c,f){const m=l("Head"),C=l("ChatList"),v=l("ChatMessage"),w=l("PromptForm"),k=l("AuthenticatedLayout");return a(),r(d,null,[h(m,{title:"Chat"}),h(k,null,{header:_(()=>[B,o("select",{class:"ml-3 block lg:hidden",onChange:s[0]||(s[0]=n=>t.go(t.$route("chat.session",n.target.value)))},[(a(!0),r(d,null,p(t.sessions,n=>(a(),r("option",{value:n.id,key:n.id},g(n.prompt.slice(0,25)),9,E))),128))],32),o("div",W,[o("a",{href:"/share/"+t.sessionId,class:"inline-flex"},[F,$(" Share ")],8,j)])]),default:_(()=>[o("div",A,[h(C,{sessions:t.sessions},null,8,["sessions"]),o("div",U,[o("div",O,[o("div",{ref:"chatWindow",class:"absolute inset-0 overflow-y-scroll",onScroll:s[1]||(s[1]=(...n)=>t.handleScroll&&t.handleScroll(...n))},[o("div",R,[t.messages.length==0?(a(),r("div",V,q)):(a(!0),r(d,{key:1},p(t.messages,(n,Q)=>(a(),r("div",null,[h(v,{message:n},null,8,["message"])]))),256))])],544)]),o("div",z,[h(w,{onSend:t.send,prompt:t.prompt,"onUpdate:prompt":s[2]||(s[2]=n=>t.prompt=n)},null,8,["onSend","prompt"]),o("div",D,[o("code",G,"tokens: "+g(t.totalTokens)+" | cost: "+g(t.totalCost),1)]),o("div",Z,[(a(!0),r(d,null,p(t.users,n=>(a(),r("div",{key:n.id},[o("img",{class:"h-4 w-4 rounded-full bg-gray-50",src:n.avatar_url,alt:n.name+"avatar"},null,8,J)]))),128))])])])])]),_:1})],64)}const ns=H(M,[["render",K]]);export{ns as default};
