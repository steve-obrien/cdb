import{l as x,Z as y,j as S,x as p,O as T,p as l,o as a,f as i,a as h,w as C,F as d,b as o,q as g,t as m}from"./app-689c2a59.js";import $ from"./PromptForm-971864c2.js";import b from"./ChatMessage-03d5d532.js";import{_ as L}from"./AuthenticatedLayout-77303e5e.js";import I from"./ChatList-822a38ba.js";import{_ as P}from"./_plugin-vue_export-helper-c27b6911.js";const B=x({props:{user:Object,chats:Array,sessions:Array,sessionId:{required:!0,type:String}},components:{Head:y,Link:S,AuthenticatedLayout:L,PromptForm:$,ChatMessage:b,ChatList:I},data(){return{prompt:"",data:[],messages:[],charsPerToken:4,tokenCostPerThousand:.005,isUserScrollBottom:!0,channel:null,channelTeam:null,users:{}}},unmounted(){window.Echo.leave(`chat.${this.sessionId}`)},mounted(){window.chat=this,this.messages=this.chats,p(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)});const t=window.Echo.join(`chat.${this.sessionId}`).here(s=>{console.log(s,"chat session channel"),s.forEach(e=>{this.users[e.id]=e})}).joining(s=>{console.log("joining",s.name),this.users[s.id]=s}).leaving(s=>{this.$page.props.auth.user.id!==s.id&&delete this.users[s.id]}).error(s=>{console.error(s)});t.listen("ChatMessage",s=>{console.log("ChatMessage - new from push",s),this.addChatChunk(s.message,"")}),t.listen("ChatMessageChunk",s=>{this.addChatChunk(s.message,s.contentChunk),console.log("ChatMessageChunk",s)})},computed:{messageCosts(){let t="";return this.messages.map(s=>{t+=s.content;let e=t.length;s.role=="assistant"&&(e=s.content.length);const r=e/this.charsPerToken,c=r/1e3*this.tokenCostPerThousand,f=s.content.length/this.charsPerToken,u=s.content.length;return{role:s.role,length:e,messageLength:u,tokens:r,cost:c,mesageTokens:f}})},total(){const s=this.messageCosts.reduce((r,c)=>r+c.length,0)/this.charsPerToken,e=s/1e3*this.tokenCostPerThousand;return{tokens:s,cost:e.toFixed(4)}}},methods:{go(t){T.visit(t)},addChatChunk(t,s){this.addMessage(t,s),p(()=>{this.scrollToBottom()})},addMessage(t,s){const e=this.messages.findIndex(r=>r.id===t.id);e===-1?this.messages.push(t):this.messages[e].content=(this.messages[e].content??"")+(s.delta.content??"")},handleScroll(){console.log("USER SCROLL");let t=this.$refs.chatWindow;this.isUserScrollBottom=t.scrollTop+t.clientHeight>=t.scrollHeight-40},scrollToBottom(){let t=this.$refs.chatWindow;this.isUserScrollBottom&&t.scrollTo(0,t.scrollHeight)},send:async function(t){const s=t.prompt,e=await axios.post(route("api.chatStart"),{sessionId:this.sessionId,prompt:s});e.status!=200&&alert("error!"),console.log(e.data,"response.data"),e.data.sessionId!==this.sessionId&&alert("session ids do not match!?"),e.data.chat,p(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)}),this.prompt="",this.streamResponse(this.sessionId)},streamResponse(t){try{const s=new EventSource(route("api.chatStream",t),{withCredentials:!0});s.addEventListener("stop",e=>{s.close()}),s.addEventListener("error",e=>{console.error("EventSource failed:",e)})}catch(s){console.error("There was a problem with the streaming operation:",s)}}}});const E=o("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Chat",-1),H=["value"],M={class:"flex h-full"},W={class:"@container h-full grow flex flex-col bg-white dark:bg-black"},j={class:"grow flex relative"},A={class:"px-4 py-8 flex flex-col flex-1 text-base mx-auto gap-5 @md:max-w-3xl @lg:max-w-[40rem] @xl:max-w-[48rem] group final-completion"},F={key:0},U=o("div",{class:"flex"},[o("div",{class:"h-8 w-8 min-w-8 mr-2 rounded-full flex items-center justify-center bg-black text-white"},"AI"),o("div",null,[o("div",{class:"mt-1 font-semibold"},"ChatGPT"),o("div",{class:"prose"},"How can I help you today?")])],-1),O=[U],R={class:"px-4"},q={class:"text-center"},N={class:"text-xs"},V={class:"flex"},D=["src","alt"];function G(t,s,e,r,c,f){const u=l("Head"),_=l("ChatList"),v=l("ChatMessage"),w=l("PromptForm"),k=l("AuthenticatedLayout");return a(),i(d,null,[h(u,{title:"Chat"}),h(k,null,{header:C(()=>[E,o("select",{class:"ml-3 block lg:hidden",onChange:s[0]||(s[0]=n=>t.go(t.$route("chat.session",n.target.value)))},[(a(!0),i(d,null,g(t.sessions,n=>(a(),i("option",{value:n.id,key:n.id},m(n.prompt.slice(0,25)),9,H))),128))],32)]),default:C(()=>[o("div",M,[h(_,{sessions:t.sessions},null,8,["sessions"]),o("div",W,[o("div",j,[o("div",{ref:"chatWindow",class:"absolute inset-0 overflow-y-scroll",onScroll:s[1]||(s[1]=(...n)=>t.handleScroll&&t.handleScroll(...n))},[o("div",A,[t.messages.length==0?(a(),i("div",F,O)):(a(!0),i(d,{key:1},g(t.messages,(n,Z)=>(a(),i("div",null,[h(v,{message:n},null,8,["message"])]))),256))])],544)]),o("div",R,[h(w,{onSend:t.send,prompt:t.prompt,"onUpdate:prompt":s[2]||(s[2]=n=>t.prompt=n)},null,8,["onSend","prompt"]),o("div",q,[o("code",N,"tokens: "+m(t.total.tokens)+" / cost: "+m(t.total.cost)+" - scroll: "+m(t.isUserScrollBottom),1)]),o("div",V,[(a(!0),i(d,null,g(t.users,n=>(a(),i("div",{key:n.id},[o("img",{class:"h-4 w-4 rounded-full bg-gray-50",src:n.avatar_url,alt:n.name+"avatar"},null,8,D)]))),128))])])])])]),_:1})],64)}const ss=P(B,[["render",G]]);export{ss as default};
