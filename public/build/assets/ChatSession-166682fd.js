import{l as x,Z as y,j as T,x as m,O as S,p as l,o as a,f as r,a as h,w as C,F as d,b as o,q as p,t as g}from"./app-141596ac.js";import $ from"./PromptForm-d55fdeee.js";import b from"./ChatMessage-b7a13b9f.js";import{_ as L}from"./AuthenticatedLayout-5d316374.js";import I from"./ChatList-116f8cc4.js";import{_ as P}from"./_plugin-vue_export-helper-c27b6911.js";const E=x({props:{user:Object,chats:Array,sessions:Array,sessionId:{required:!0,type:String}},components:{Head:y,Link:T,AuthenticatedLayout:L,PromptForm:$,ChatMessage:b,ChatList:I},data(){return{prompt:"",data:[],messages:[],charsPerToken:4,tokenCostPerThousand:.005,isUserScrollBottom:!0,channel:null,channelTeam:null,users:{}}},unmounted(){window.Echo.leave(`chat.${this.sessionId}`)},mounted(){window.chat=this,this.messages=this.chats,m(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)});const s=window.Echo.join(`chat.${this.sessionId}`).here(t=>{console.log(t,"chat session channel"),t.forEach(e=>{this.users[e.id]=e})}).joining(t=>{console.log("joining",t.name),this.users[t.id]=t}).leaving(t=>{this.$page.props.auth.user.id!==t.id&&delete this.users[t.id]}).error(t=>{console.error(t)});s.listen("ChatMessage",t=>{console.log("ChatMessage - new from push",t),this.addChatChunk(t.message,"")}),s.listen("ChatMessageChunk",t=>{this.addChatChunk(t.message,t.contentChunk),console.log("ChatMessageChunk",t)})},computed:{messageCosts(){let s="";return this.messages.map(t=>{s+=t.content;let e=s.length;t.role=="assistant"&&(e=t.content.length);const i=e/this.charsPerToken,c=i/1e3*this.tokenCostPerThousand,f=t.content.length/this.charsPerToken,u=t.content.length;return{role:t.role,length:e,messageLength:u,tokens:i,cost:c,mesageTokens:f}})},total(){const t=this.messageCosts.reduce((i,c)=>i+c.length,0)/this.charsPerToken,e=t/1e3*this.tokenCostPerThousand;return{tokens:t,cost:e.toFixed(4)}},totalTokens(){return this.messages.reduce((s,t)=>typeof t.total_tokens=="number"?s+t.total_tokens:s,0)},totalCost(){return(this.totalTokens/1e3*this.tokenCostPerThousand).toFixed(4)}},methods:{go(s){S.visit(s)},addChatChunk(s,t){this.addMessage(s,t),m(()=>{this.scrollToBottom()})},addMessage(s,t){const e=this.messages.findIndex(i=>i.id===s.id);e===-1?this.messages.push(s):this.messages[e].content=(this.messages[e].content??"")+(t.delta.content??"")},handleScroll(){console.log("USER SCROLL");let s=this.$refs.chatWindow;this.isUserScrollBottom=s.scrollTop+s.clientHeight>=s.scrollHeight-100},scrollToBottom(){this.isUserScrollBottom&&this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)},send:async function(s){const t=s.prompt,e=await axios.post(route("api.chatStart"),{sessionId:this.sessionId,prompt:t});e.status!=200&&alert("error!"),console.log(e.data,"response.data"),e.data.sessionId!==this.sessionId&&alert("session ids do not match!?"),e.data.chat,m(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)}),this.prompt="",this.streamResponse(this.sessionId)},streamResponse(s){try{const t=new EventSource(route("api.chatStream",s),{withCredentials:!0});t.addEventListener("stop",e=>{t.close()}),t.addEventListener("error",e=>{console.error("EventSource failed:",e)})}catch(t){console.error("There was a problem with the streaming operation:",t)}}}});const H=o("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Chat",-1),M=["value"],W={class:"flex h-full"},B={class:"@container h-full grow flex flex-col bg-white dark:bg-black"},F={class:"grow flex relative"},j={class:"px-4 py-8 flex flex-col flex-1 text-base mx-auto gap-5 @md:max-w-3xl @lg:max-w-[40rem] @xl:max-w-[48rem] group final-completion"},A={key:0},U=o("div",{class:"flex"},[o("div",{class:"h-8 w-8 min-w-8 mr-2 rounded-full flex items-center justify-center bg-black text-white"},"AI"),o("div",null,[o("div",{class:"mt-1 font-semibold"},"ChatGPT"),o("div",{class:"prose"},"How can I help you today?")])],-1),O=[U],R={class:"px-4"},q={class:"text-center"},N={class:"text-xs"},V={class:"flex"},D=["src","alt"];function G(s,t,e,i,c,f){const u=l("Head"),_=l("ChatList"),v=l("ChatMessage"),k=l("PromptForm"),w=l("AuthenticatedLayout");return a(),r(d,null,[h(u,{title:"Chat"}),h(w,null,{header:C(()=>[H,o("select",{class:"ml-3 block lg:hidden",onChange:t[0]||(t[0]=n=>s.go(s.$route("chat.session",n.target.value)))},[(a(!0),r(d,null,p(s.sessions,n=>(a(),r("option",{value:n.id,key:n.id},g(n.prompt.slice(0,25)),9,M))),128))],32)]),default:C(()=>[o("div",W,[h(_,{sessions:s.sessions},null,8,["sessions"]),o("div",B,[o("div",F,[o("div",{ref:"chatWindow",class:"absolute inset-0 overflow-y-scroll",onScroll:t[1]||(t[1]=(...n)=>s.handleScroll&&s.handleScroll(...n))},[o("div",j,[s.messages.length==0?(a(),r("div",A,O)):(a(!0),r(d,{key:1},p(s.messages,(n,Z)=>(a(),r("div",null,[h(v,{message:n},null,8,["message"])]))),256))])],544)]),o("div",R,[h(k,{onSend:s.send,prompt:s.prompt,"onUpdate:prompt":t[2]||(t[2]=n=>s.prompt=n)},null,8,["onSend","prompt"]),o("div",q,[o("code",N,"tokens: "+g(s.totalTokens)+" | cost: "+g(s.totalCost),1)]),o("div",V,[(a(!0),r(d,null,p(s.users,n=>(a(),r("div",{key:n.id},[o("img",{class:"h-4 w-4 rounded-full bg-gray-50",src:n.avatar_url,alt:n.name+"avatar"},null,8,D)]))),128))])])])])]),_:1})],64)}const tt=P(E,[["render",G]]);export{tt as default};
