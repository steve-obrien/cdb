import{l as w,Z as C,j as x,x as u,O as T,p as c,o as r,f as a,a as d,b as o,F as h,q as p,t as g}from"./app-141596ac.js";import y from"./PromptForm-d55fdeee.js";import S from"./ChatMessage-b7a13b9f.js";import{_ as b}from"./AuthenticatedLayout-5d316374.js";import $ from"./ChatList-116f8cc4.js";import{_ as P}from"./_plugin-vue_export-helper-c27b6911.js";const I=w({props:{user:Object,chats:Array,sessions:Array,sessionId:{required:!0,type:String}},components:{Head:C,Link:x,AuthenticatedLayout:b,PromptForm:y,ChatMessage:S,ChatList:$},data(){return{prompt:"",data:[],messages:[],charsPerToken:4,tokenCostPerThousand:.005,isUserScrollBottom:!0,channel:null,channelTeam:null,users:{}}},unmounted(){window.Echo.leave(`chat.${this.sessionId}`)},mounted(){window.chat=this,this.messages=this.chats,u(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)})},computed:{messageCosts(){let t="";return this.messages.map(s=>{t+=s.content;let e=t.length;s.role=="assistant"&&(e=s.content.length);const l=e/this.charsPerToken,i=l/1e3*this.tokenCostPerThousand,f=s.content.length/this.charsPerToken,m=s.content.length;return{role:s.role,length:e,messageLength:m,tokens:l,cost:i,mesageTokens:f}})},total(){const s=this.messageCosts.reduce((l,i)=>l+i.length,0)/this.charsPerToken,e=s/1e3*this.tokenCostPerThousand;return{tokens:s,cost:e.toFixed(4)}},totalTokens(){return this.messages.reduce((t,s)=>typeof s.total_tokens=="number"?t+s.total_tokens:t,0)},totalCost(){return(this.totalTokens/1e3*this.tokenCostPerThousand).toFixed(4)}},methods:{go(t){T.visit(t)},addChatChunk(t,s){this.addMessage(t,s),u(()=>{this.scrollToBottom()})},addMessage(t,s){const e=this.messages.findIndex(l=>l.id===t.id);e===-1?this.messages.push(t):this.messages[e].content=(this.messages[e].content??"")+(s.delta.content??"")},handleScroll(){console.log("USER SCROLL");let t=this.$refs.chatWindow;this.isUserScrollBottom=t.scrollTop+t.clientHeight>=t.scrollHeight-100},scrollToBottom(){this.isUserScrollBottom&&this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)},send:async function(t){const s=t.prompt,e=await axios.post(route("api.chatStart"),{sessionId:this.sessionId,prompt:s});e.status!=200&&alert("error!"),console.log(e.data,"response.data"),e.data.sessionId!==this.sessionId&&alert("session ids do not match!?"),e.data.chat,u(()=>{this.$refs.chatWindow.scrollTo(0,this.$refs.chatWindow.scrollHeight)}),this.prompt="",this.streamResponse(this.sessionId)},streamResponse(t){try{const s=new EventSource(route("api.chatStream",t),{withCredentials:!0});s.addEventListener("stop",e=>{s.close()}),s.addEventListener("error",e=>{console.error("EventSource failed:",e)})}catch(s){console.error("There was a problem with the streaming operation:",s)}}}});const L=o("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Chat",-1),H=["value"],W={class:"flex h-full"},B={class:"@container h-full grow flex flex-col bg-white dark:bg-black"},E={class:"grow flex relative"},F={class:"px-4 py-8 flex flex-col flex-1 text-base mx-auto gap-5 @md:max-w-3xl @lg:max-w-[40rem] @xl:max-w-[48rem] group final-completion"},M={key:0},U=o("div",{class:"flex"},[o("div",{class:"h-8 w-8 min-w-8 mr-2 rounded-full flex items-center justify-center bg-black text-white"},"AI"),o("div",null,[o("div",{class:"mt-1 font-semibold"},"ChatGPT"),o("div",{class:"prose"},"How can I help you today?")])],-1),A=[U],O={class:"px-4"},R={class:"text-center"},j={class:"text-xs"},q={class:"flex"},N=["src","alt"];function V(t,s,e,l,i,f){const m=c("Head"),_=c("ChatList"),v=c("ChatMessage"),k=c("PromptForm");return r(),a(h,null,[d(m,{title:"Chat"}),L,o("select",{class:"ml-3 block lg:hidden",onChange:s[0]||(s[0]=n=>t.go(t.$route("chat.session",n.target.value)))},[(r(!0),a(h,null,p(t.sessions,n=>(r(),a("option",{value:n.id,key:n.id},g(n.prompt.slice(0,25)),9,H))),128))],32),o("div",W,[d(_,{sessions:t.sessions},null,8,["sessions"]),o("div",B,[o("div",E,[o("div",{ref:"chatWindow",class:"absolute inset-0 overflow-y-scroll",onScroll:s[1]||(s[1]=(...n)=>t.handleScroll&&t.handleScroll(...n))},[o("div",F,[t.messages.length==0?(r(),a("div",M,A)):(r(!0),a(h,{key:1},p(t.messages,(n,D)=>(r(),a("div",null,[d(v,{message:n},null,8,["message"])]))),256))])],544)]),o("div",O,[d(k,{onSend:t.send,prompt:t.prompt,"onUpdate:prompt":s[2]||(s[2]=n=>t.prompt=n)},null,8,["onSend","prompt"]),o("div",R,[o("code",j,"tokens: "+g(t.totalTokens)+" | cost: "+g(t.totalCost),1)]),o("div",q,[(r(!0),a(h,null,p(t.users,n=>(r(),a("div",{key:n.id},[o("img",{class:"h-4 w-4 rounded-full bg-gray-50",src:n.avatar_url,alt:n.name+"avatar"},null,8,N)]))),128))])])])])],64)}const X=P(I,[["render",V]]);export{X as default};
